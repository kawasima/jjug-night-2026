<!-- TOC ナビゲーション (キー [n] で開閉) - サムネイル一覧 -->
<nav id="toc-nav" style="
  display:none;
  position:fixed;
  top:0; left:0;
  width:100vw; height:100vh;
  background:rgba(20,20,28,0.96);
  z-index:1000;
  overflow-y:auto;
  padding:2rem;
  box-sizing:border-box;
  font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;
">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem;max-width:1400px;margin-left:auto;margin-right:auto;">
    <h3 style="margin:0;font-size:1rem;text-transform:uppercase;letter-spacing:0.1em;color:#aaa;">目次</h3>
    <span style="font-size:0.75rem;color:#666;">[ n ] で開閉・クリックでジャンプ</span>
  </div>
  <div id="toc-grid" style="
    display:grid;
    grid-template-columns:repeat(auto-fill,minmax(260px,1fr));
    gap:1.25rem;
    max-width:1400px;
    margin:0 auto;
  "></div>
</nav>

<style>
  #toc-nav .thumb-card {
    position:relative;
    background:#fff;
    border-radius:8px;
    overflow:hidden;
    cursor:pointer;
    box-shadow:0 2px 8px rgba(0,0,0,0.3);
    transition:transform 0.15s, box-shadow 0.15s;
    aspect-ratio:16/9;
  }
  #toc-nav .thumb-card:hover {
    transform:translateY(-3px) scale(1.02);
    box-shadow:0 6px 20px rgba(0,0,0,0.4);
  }
  #toc-nav .thumb-card.current {
    outline:3px solid #0563c1;
    outline-offset:-3px;
  }
  #toc-nav .thumb-card.current::after {
    content:'';
    position:absolute;
    inset:0;
    border:3px solid #0563c1;
    border-radius:8px;
    pointer-events:none;
    z-index:2;
  }
  #toc-nav .thumb-label {
    position:absolute;
    bottom:0;
    left:0;
    right:0;
    padding:0.4rem 0.6rem;
    background:linear-gradient(transparent,rgba(0,0,0,0.6));
    color:#fff;
    font-size:0.75rem;
    line-height:1.3;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    z-index:1;
  }
  #toc-nav .thumb-num {
    color:rgba(255,255,255,0.7);
    margin-right:0.35rem;
  }
  /* サムネイル用 SVG クローン */
  #toc-nav .thumb-frame {
    position:absolute;
    inset:0;
    overflow:hidden;
  }
  #toc-nav .thumb-frame > svg[data-marpit-svg] {
    /* svg[data-marpit-svg] のグローバルスタイル(100vh/100vw)に勝つ */
    position:absolute !important;
    top:0 !important;
    left:0 !important;
    width:1280px !important;
    height:720px !important;
    transform-origin:top left;
    /* scale は JS で動的に設定 */
  }
</style>

<script>
(function () {
  var nav = document.getElementById('toc-nav');
  var grid = document.getElementById('toc-grid');
  var slideSvgs = []; // svg[data-marpit-svg] の一覧

  function getSlideSvgs() {
    return Array.prototype.slice.call(document.querySelectorAll('svg[data-marpit-svg]'));
  }

  function getActiveIndex() {
    var svgs = getSlideSvgs();
    for (var i = 0; i < svgs.length; i++) {
      if (svgs[i].classList.contains('bespoke-marp-active')) return i;
    }
    return 0;
  }

  function buildToc() {
    slideSvgs = getSlideSvgs();
    if (slideSvgs.length === 0) return; // まだ初期化されていない

    grid.innerHTML = '';
    slideSvgs.forEach(function (svg, i) {
      var section = svg.querySelector('section');
      var heading = section ? section.querySelector('h1, h2, h3') : null;
      var label = heading ? heading.textContent.trim() : 'スライド ' + (i + 1);

      // カード
      var card = document.createElement('div');
      card.className = 'thumb-card';
      card.dataset.slideIndex = i;

      // サムネイル枠: SVG を丸ごとクローンして縮小
      var frame = document.createElement('div');
      frame.className = 'thumb-frame';

      var clonedSvg = svg.cloneNode(true);
      // bespoke のクラス・属性は unnecessary なので削除
      clonedSvg.removeAttribute('class');
      clonedSvg.setAttribute('data-marpit-svg', '');
      // viewBox を維持して正しくレンダリングされるようにする
      frame.appendChild(clonedSvg);
      card.appendChild(frame);

      // ラベル
      var lbl = document.createElement('div');
      lbl.className = 'thumb-label';
      lbl.innerHTML = '<span class="thumb-num">' + (i + 1) + '</span>' + escapeHtml(label);
      card.appendChild(lbl);

      // クリック時遷移
      card.addEventListener('click', function () {
        closeToc();
        navigateToSlide(i);
      });

      grid.appendChild(card);
    });
    scaleFrames();
  }

  function scaleFrames() {
    var cards = grid.querySelectorAll('.thumb-card');
    cards.forEach(function (card) {
      var svg = card.querySelector('.thumb-frame > svg');
      if (!svg) return;
      var cardW = card.offsetWidth;
      var scale = cardW / 1280;
      svg.style.transform = 'scale(' + scale + ')';
    });
  }

  function updateHighlight() {
    var idx = getActiveIndex();
    grid.querySelectorAll('.thumb-card').forEach(function (card, i) {
      card.classList.toggle('current', i === idx);
    });
  }

  function navigateToSlide(index) {
    // marp-cli bespoke モード: hash は 1-indexed (#1, #2, #3 ...)
    // hashchange イベントで bespoke がスライド切り替えを検知する
    location.hash = '#' + (index + 1);
  }

  function openToc() {
    nav.style.display = 'block';
    nav.classList.add('open');
    // サムネイルがまだなければビルド
    if (grid.children.length === 0) {
      buildToc();
    }
    requestAnimationFrame(function () {
      scaleFrames();
      updateHighlight();
    });
  }

  function closeToc() {
    nav.style.display = 'none';
    nav.classList.remove('open');
  }

  // キーボード開閉
  document.addEventListener('keydown', function (e) {
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
    if (e.key === 'n' || e.key === 'N') {
      if (nav.classList.contains('open')) {
        closeToc();
      } else {
        openToc();
      }
    }
  });

  // リサイズ時にスケール再計算
  window.addEventListener('resize', function () {
    if (nav.classList.contains('open')) scaleFrames();
  });

  // bespoke のスライド変化時にハイライト更新
  var highlightObserver = new MutationObserver(function () {
    if (nav.classList.contains('open')) updateHighlight();
  });

  function init() {
    // svg[data-marpit-svg] に bespoke-marp-active クラス変化を監視
    var svgs = getSlideSvgs();
    svgs.forEach(function (svg) {
      highlightObserver.observe(svg, { attributes: true, attributeFilter: ['class'] });
    });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }

  function escapeHtml(str) {
    return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }
})();
</script>
